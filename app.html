<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Win Bus Tracking</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body { font-family: 'Inter', sans-serif; }
.fade-in { animation: fadeIn .3s ease; }
@keyframes fadeIn {
  from { opacity:0; transform:translateY(10px); }
  to { opacity:1; transform:translateY(0); }
}
</style>
</head>

<body class="bg-gray-100">

<div class="max-w-5xl mx-auto p-6">

<h1 class="text-3xl font-bold mb-4">ðŸšŒ Win Bus Live Tracking</h1>

<!-- COMMON SMART SEARCH -->
<input
  id="smartSearch"
  type="text"
  placeholder="Search operator, city, route (ex: SMS Travels, Chennai Madurai)"
  class="w-full p-4 rounded-xl border focus:ring-2 focus:ring-blue-500 mb-4"
/>

<!-- SORT OPTIONS -->
<div class="flex gap-4 mb-6">
  <select id="sortOperator" class="p-2 border rounded">
    <option value="">Sort Operator</option>
    <option value="az">A â†’ Z</option>
    <option value="za">Z â†’ A</option>
  </select>

  <select id="sortTime" class="p-2 border rounded">
    <option value="">Sort Time</option>
    <option value="early">Early â†’ Late</option>
    <option value="late">Late â†’ Early</option>
  </select>
</div>

<!-- RESULTS -->
<div id="results" class="space-y-4"></div>

</div>

<!-- TRACKING MODAL -->
<div id="trackModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center">
  <div class="bg-white w-11/12 max-w-4xl h-5/6 rounded-xl">
    <div class="flex justify-between p-3 border-b">
      <h3 class="font-bold">Live Tracking</h3>
      <button onclick="closeTrack()">âœ–</button>
    </div>
    <iframe id="trackFrame" class="w-full h-full"></iframe>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let allBuses = [];
let current = [];

async function loadBuses() {
  const snap = await getDocs(collection(db,"buses"));
  allBuses = snap.docs.map(d => d.data());
}
await loadBuses();

const results = document.getElementById("results");

function render(list) {
  results.innerHTML = `<p class="text-gray-500">${list.length} buses found</p>`;
  const grouped = {};

  list.forEach(b => {
    grouped[b.travelsName] ??= [];
    grouped[b.travelsName].push(b);
  });

  Object.keys(grouped).forEach(op => {
    const card = document.createElement("div");
    card.className = "bg-white p-5 rounded-xl shadow fade-in";
    card.innerHTML = `<h2 class="text-xl font-bold">${op}</h2>` +
      grouped[op].map(b => `
        <div class="border-t pt-3 mt-3 flex justify-between">
          <div>
            <p>${b.from} â†’ ${b.to}</p>
            <p class="text-sm text-gray-500">${b.departureTime}</p>
          </div>
          <button class="bg-green-500 text-white px-4 py-2 rounded"
            onclick="openTrack('${b.trackingLink}')">
            Track
          </button>
        </div>
      `).join("");
    results.appendChild(card);
  });
}

function smartSearch(q) {
  const words = q.toLowerCase().split(" ");
  return allBuses.filter(b => {
    const text = `
      ${b.travelsName} ${b.from} ${b.to}
      ${b.busType} ${b.intermediateStops?.join(" ")}
    `.toLowerCase();
    return words.every(w => text.includes(w));
  });
}

document.getElementById("smartSearch").addEventListener("input", e => {
  if (e.target.value.length < 2) return results.innerHTML="";
  current = smartSearch(e.target.value);
  render(current);
});

document.getElementById("sortOperator").addEventListener("change", e => {
  if (e.target.value==="az") current.sort((a,b)=>a.travelsName.localeCompare(b.travelsName));
  if (e.target.value==="za") current.sort((a,b)=>b.travelsName.localeCompare(a.travelsName));
  render(current);
});

document.getElementById("sortTime").addEventListener("change", e => {
  current.sort((a,b)=>
    e.target.value==="early"
    ? a.departureTime.localeCompare(b.departureTime)
    : b.departureTime.localeCompare(a.departureTime)
  );
  render(current);
});

window.openTrack = url => {
  document.getElementById("trackFrame").src = url;
  document.getElementById("trackModal").classList.remove("hidden");
}
window.closeTrack = () => {
  document.getElementById("trackFrame").src="";
  document.getElementById("trackModal").classList.add("hidden");
}
</script>

</body>
</html>
